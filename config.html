<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Config</title>
        <!-- librerias de estilos y js jquery y zoe -->
  <link rel="stylesheet" href="css/themes/zoe.min.css" />
  <link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
  <link rel="stylesheet" href="js/jquery-mobile/jquery.mobile.structure-1.4.5.min.css" />
  <link rel="stylesheet" href="js/zoe/jquery.mobile.simpledialog.min.css" />

  <!--link rel="stylesheet" href="js/jquery-mobile/jquery.mobile-1.4.5.min.css" /-->  
<script src="js/jquery-mobile/jquery-2.1.4.js" type="text/javascript"></script>
<script src="js/jquery-mobile/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
<script type="text/javascript" src="phonegap.js"></script>
<script src="js/zoe/zoe.js" type="text/javascript"></script>
<script src="js/zoe/zoesync.js" type="text/javascript"></script>
<script src="js/zoe/salesRepDAO.js" type="text/javascript"></script>
<script src="js/zoe/customerDAO.js" type="text/javascript"></script>
<!-- fin librerias -->

<script>
		$(document).bind("pagebeforecreate", function(event) {
			console.log("en pagebeforecreate config.html salesRepName=" + window.localStorage.getItem(
	"salesRepName"));
			initAnyPage(event.target);
			$('#salesRepName').val(window.localStorage.getItem("salesRepName"));	
			$('#submitConfig').click(submitFormConfig);	
			$('#syncSalesRep').click(syncSalesRep);	
			$('#syncCustomers').click(syncCustomers);	
			$('#createDB').click(checkDatabase);	
			logZoe("config.html listo pagebeforecreate");
		});

	function submitFormConfig(form) {
		window.localStorage.setItem("salesRepName", $('#salesRepName').val());
		logZoe("config localStorage salesRepName=" + window.localStorage.getItem("salesRepName"));
		return false;
	}
	
	function syncSalesRep(form){
		console.log("entre a syncSalesRep");
		var mensaje = 	
		'		<EmployeeQueryRq requestID="c1"><OwnerID>0</OwnerID></EmployeeQueryRq>';
		var cache = "employee";
		var xpathExp = '//EmployeeRet[Name="' + window.localStorage.getItem("salesRepName") + '"]';				
		consumeWS(mensaje, "JSON", receiveMessage,cache, xpathExp);
		
		return false;
	}
	
	function syncCustomers(form){
		console.log("entre a syncCustomers");
		var mensaje = 	
		'<CustomerQueryRq  requestID="aaa2"></CustomerQueryRq>';
		var cache="customers";
		var xpathExp = "//CustomerRet[SalesRepRef/FullName='7']";
			
		consumeWS(mensaje, "JSON", receiveCustomersMessage, cache, xpathExp);
		return false;
	}

	var salesRepVO;
	function receiveMessage(message){
		var employee = message.EmployeeQueryRs;
		salesRepVO = {id_salesRep:employee.EmployeeRet.ListID,
			name:employee.EmployeeRet.Name, 
			password:employee.EmployeeRet.DataExtRet[0].DataExtValue, 
			isActive:employee.EmployeeRet.IsActive, 
			syncTime:Date.now(), Initial:""};
			
		var mensajeSalesRep = '<SalesRepQueryRq requestID="c1"></SalesRepQueryRq>';
		var cache = "salesrep";
		var xpathExp = '//SalesRepRet[SalesRepEntityRef/FullName="' + window.localStorage.getItem('salesRepName') + '"';

		
		consumeWS(mensajeSalesRep, "JSON", receiveMessageSalesRep,cache, xpathExp);
			
	}

	function receiveMessageSalesRep(message){
		
		var salesRep = message.SalesRepQueryRs;
		logZoe("receiveMessageSalesRep salesRep=" + JSON.stringify(salesRep));
		logZoe("receiveMessageSalesRep salesRep.Initial=" + JSON.stringify(salesRep.Initial));
		salesRepVO.Initial = salesRep.Initial;
		logZoe("receiveMessageSalesRep salesRepVO=" + JSON.stringify(salesRepVO));
		logZoe("receiveMessageSalesRep message=" + message);
			
		salesRepDAO.store(salesRepVO, errSalesRepSync, successSyncSalesRep);
	}
	
	function receiveCustomersMessage(message){
		var customers = message.CustomerQueryRs.CustomerRet;
		var i;
		var customersVO = [];
		for (i=0;i<customers.length;i++){
			var customerVO = {ListId:customers[i].ListID,
				FullName:customers[i].FullName, 
				OpenBalance:customers[i].Balance 
				};
				logZoe("customerVO=" + JSON.stringify(customerVO));
				customersVO[i] = customerVO;
		}
			
		customerDAO.deleteAll(errCustomerInsert);
		customerDAO.store(customersVO, errCustomerInsert, successCustomerInsert);
		
	}

	function successCustomerInsert(){
		alert("Success synch customers");
	}
	
	function errCustomerInsert(err){
		alert("DB Error synch customers: "+JSON.stringify(err));
	}

	function successSyncSalesRep(){
		alert("Success synch salesrep");
	}
	
	function errSalesRepSync(err){
		alert("DB Error synch salesrep: "+JSON.stringify(err));
	}
</script>
</head>

<body>

        <div data-role="page" id="config" data-title="Config">
        
            <div data-role="content"> 
                <form method="post" id="configForm" data-ajax="true">
                    <lable for="salesRepName">Piloch Sales Rep Full Name</lable><input type="text" id="salesRepName" name="salesRepName" placeholder="salesRepName"><br>
                                 
                        <input id="submitConfig" type="submit" value="Save">
		                <button class="ui-btn" id="syncSalesRep">Synch Sales Rep</button>
		                <button class="ui-btn" id="syncCustomers">Synch Customers</button>
		                <button class="ui-btn" id="createDB">create database</button>
                </form>
            </div>
        

<div data-role="popup" id="synchDialog" data-dismissible="false" style="width:300px">
    <div data-role="header">
    Synchronizing
    </div>
    <div role="main" class="ui-content">
		  <p>Please wait....</p>
      		<a href="#" class="ui-btn" data-rel="back">Cancel</a>
	</div>
</div>


<!-- divs de header, menu y footer-->
	<div data-role="header" data-position="fixed" data-id="theheader" class="app-header"></div>
    <div data-role="panel" data-display="overlay" data-position="left" id="menu" class="app-menu"></div>
	<div data-role="footer" data-position="fixed" data-id="thefooter" class="app-footer"></div>
<!-- fin divs -->

</div>

</body>
</html>
